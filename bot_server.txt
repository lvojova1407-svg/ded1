import os
import asyncio
import logging
from threading import Thread
from fastapi import FastAPI
from bot import main as bot_main  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤–∞—à–µ–≥–æ –±–æ—Ç–∞

app = FastAPI()
bot_thread = None

@app.get("/health")
def health_check():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –¥–ª—è Render"""
    return {"status": "ok", "bot": "running"}

@app.get("/")
def root():
    return {
        "service": "Telegram Break Bot",
        "status": "active",
        "health_check": "/health"
    }

def run_bot():
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ"""
    try:
        bot_main()
    except Exception as e:
        logging.error(f"–ë–æ—Ç —É–ø–∞–ª —Å –æ—à–∏–±–∫–æ–π: {e}")
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

def start_bot():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–µ"""
    global bot_thread
    if bot_thread is None or not bot_thread.is_alive():
        bot_thread = Thread(target=run_bot, daemon=True)
        bot_thread.start()
        logging.info("ü§ñ Telegram –±–æ—Ç –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ")

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞
@app.on_event("startup")
async def startup_event():
    start_bot()

if __name__ == "__main__":
    import uvicorn
    start_bot()
    uvicorn.run(app, host="0.0.0.0", port=int(os.getenv("PORT", 10000)))